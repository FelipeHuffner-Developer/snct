<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Galeria VR - A-Frame</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>html,body{height:100%;margin:0}a-scene{height:100%}</style>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="library" src="fundo.jpg">
        <img id="thumb1" src="imagem.jpg">
        <img id="thumb2" src="imagemcitha.jpg">
        <img id="pano1" src="imagem.jpg">
        <img id="pano2" src="imagemcitha.jpg">
        <img id="pano3" src="imagem.jpg">
        <audio id="audio-pano1" src="audio.mp3" preload="auto"></audio>
        <audio id="audio-pano2" src="audiocitha.mp3" preload="auto"></audio>
        <audio id="audio-pano3" src="audio.mp3" preload="auto"></audio>
      </a-assets>

      <!-- Galeria com miniaturas e tooltips -->
      <a-entity id="gallery" position="0 1.6 -3">
        <a-plane class="thumb" id="thumb-1" src="#thumb1" height="1" width="1.6" position="-2 0 0" material="shader: flat"></a-plane>
        <a-entity id="tooltip-1" visible="false" position="-2 0.8 0">
          <a-plane width="1.6" height="0.4" color="#00FF00" opacity="0.8"></a-plane>
          <a-text value="Praia da Ponta Branca" color="#fff" align="center" width="1.4" position="0 0 0.01"></a-text>
        </a-entity>

       <a-plane class="thumb" id="thumb-2" src="#thumb2" height="1" width="1.6" position="0 0 0" material="shader: flat"></a-plane>
        <a-entity id="tooltip-2" visible="false" position="0 0.8 0">
          <a-plane width="1.6" height="0.4" color="#00FF00" opacity="0.8"></a-plane>
          <a-text value="CITHA Turma 2" color="#fff" align="center" width="1.4" position="0 0 0.01"></a-text>
        </a-entity>

       <a-plane class="thumb" id="thumb-3" src="#thumb1" height="1" width="1.6" position="2 0 0" material="shader: flat"></a-plane>
        <a-entity id="tooltip-3" visible="false" position="2 0.8 0">
          <a-plane width="1.6" height="0.4" color="#00FF00" opacity="0.8"></a-plane>
          <a-text value="Abrir panorama 3" color="#fff" align="center" width="1.4" position="0 0 0.01"></a-text>
        </a-entity>
      </a-entity>

  <!--Sky inicial (fundo da galeria: biblioteca) -->
  <a-sky id="main-sky" src="#library"></a-sky>

      <!-- Câmera e cursor com fuse de 5s -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-entity camera look-controls>
          <a-entity id="cursor" cursor="fuse: true; fuseTimeout: 5000" position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: #333; shader: flat">
            <a-ring id="gaze-progress" radius-inner="0.03" radius-outer="0.031" material="color: #0f0; shader: flat; opacity: 0.9" scale="0 0 0"></a-ring>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Botão Voltar -->
      <a-entity id="back-button" visible="false" position="0 1.2 -1.5">
        <a-plane id="back-plate" width="0.8" height="0.3" color="#00FF00" opacity="0.8"></a-plane>
        <a-text value="Voltar" align="center" color="#fff" width="0.7" position="0 0 0.01"></a-text>
      </a-entity>

    </a-scene>

    <script>
    (function(){
      // Áudio controlado por panorama (toca apenas dentro do panorama)
      function pauseAllAudio(){
        var audios = document.querySelectorAll('audio');
        audios.forEach(function(a){ try{ a.pause(); a.currentTime = 0; }catch(e){} });
      }
      function playAudioById(id){
        if(!id) return;
        pauseAllAudio();
        var a = document.querySelector(id);
        if(!a) return;
        a.loop = true;
        var p = a.play();
        if(p !== undefined){
          p.catch(function(){
            function unlock(){ a.play(); window.removeEventListener('click', unlock); window.removeEventListener('touchstart', unlock); }
            window.addEventListener('click', unlock, {once:true});
            window.addEventListener('touchstart', unlock, {once:true});
          });
        }
      }

      // Gaze logic
      (function(){
        var fuseTime = 5000; // 5s
        var mapping = {
          'thumb-1': { pano: '#pano1', audio: '#audio-pano1' },
          'thumb-2': { pano: '#pano2', audio: '#audio-pano2' },
          'thumb-3': { pano: '#pano1', audio: '#audio-pano1' }
        };

        var progress = document.getElementById('gaze-progress');
        var mainSky = document.getElementById('main-sky');

        var fuseTimer = null;
        var startTime = null;
        var currentTarget = null;

        function showTooltipFor(id){
          if(!id) return;
          if(id.indexOf('thumb-') === 0){
            var n = id.split('-')[1];
            var t = document.getElementById('tooltip-' + n);
            if(t) t.setAttribute('visible','true');
          }
        }
        function hideAllTooltips(){
          var tips = document.querySelectorAll('[id^="tooltip-"]');
          tips.forEach(function(t){ t.setAttribute('visible','false'); });
        }

        function startFuse(id){
          clearFuse();
          currentTarget = id;
          startTime = Date.now();
          showTooltipFor(id);
          progress.setAttribute('scale','0 0 0');
          fuseTimer = requestAnimationFrame(function tick(){
            var elapsed = Date.now() - startTime;
            var t = Math.min(1, elapsed / fuseTime);
            progress.setAttribute('scale', t + ' ' + t + ' ' + t);
            if(elapsed >= fuseTime){
              completeFuse(currentTarget);
              return;
            }
            fuseTimer = requestAnimationFrame(tick);
          });
        }

        function clearFuse(){
          if(fuseTimer){
            cancelAnimationFrame(fuseTimer);
            fuseTimer = null;
          }
          startTime = null;
          currentTarget = null;
          progress.setAttribute('scale','0 0 0');
          hideAllTooltips();
        }

        function completeFuse(id){
          clearFuse();
          if(id && mapping[id]){
            mainSky.setAttribute('src', mapping[id].pano);
            document.getElementById('back-button').setAttribute('visible','true');
            document.getElementById('gallery').setAttribute('visible','false');
            playAudioById(mapping[id].audio);
          } else if(id === 'back-button'){
            // restaurar fundo da galeria (biblioteca)
            mainSky.setAttribute('src', '#library');
            document.getElementById('back-button').setAttribute('visible','false');
            document.getElementById('gallery').setAttribute('visible','true');
            pauseAllAudio();
          }
        }

        // Listeners
        var thumbs = document.querySelectorAll('.thumb');
        thumbs.forEach(function(thumb){
          thumb.addEventListener('mouseenter', function(){ startFuse(thumb.id); });
          thumb.addEventListener('mouseleave', function(){ clearFuse(); });
        });

        var back = document.getElementById('back-plate');
        if(back){
          back.addEventListener('mouseenter', function(){ startFuse('back-button'); });
          back.addEventListener('mouseleave', function(){ clearFuse(); });
        }

      })();

    })();
    </script>
  </body>
</html>